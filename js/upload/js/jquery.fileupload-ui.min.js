(function(a){if(typeof define==="function"&&define.amd){define(["jquery","tmpl","load-image","./jquery.fileupload-fp"],a)}else{a(window.jQuery,window.tmpl,window.loadImage)}}(function(c,b,d){var a=(c.blueimpFP||c.blueimp).fileupload;c.widget("blueimpUI.fileupload",a,{options:{autoUpload:false,maxNumberOfFiles:undefined,maxFileSize:undefined,minFileSize:undefined,acceptFileTypes:/.+$/i,previewSourceFileTypes:/^image\/(gif|jpeg|png)$/,previewSourceMaxFileSize:5000000,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:true,uploadTemplateId:"template-upload",downloadTemplateId:"template-download",filesContainer:undefined,prependFiles:false,dataType:"json",add:function(j,i){var h=c(this).data("fileupload"),f=h.options,g=i.files;c(this).fileupload("process",i).done(function(){h._adjustMaxNumberOfFiles(-g.length);i.maxNumberOfFilesAdjusted=true;i.files.valid=i.isValidated=h._validate(g);i.context=h._renderUpload(g).data("data",i);f.filesContainer[f.prependFiles?"prepend":"append"](i.context);h._renderPreviews(g,i.context);h._forceReflow(i.context);h._transition(i.context).done(function(){if((h._trigger("added",j,i)!==false)&&(f.autoUpload||i.autoUpload)&&i.autoUpload!==false&&i.isValidated){i.submit()}})})},send:function(h,g){var f=c(this).data("fileupload");if(!g.isValidated){if(!g.maxNumberOfFilesAdjusted){f._adjustMaxNumberOfFiles(-g.files.length);g.maxNumberOfFilesAdjusted=true}if(!f._validate(g.files)){return false}}if(g.context&&g.dataType&&g.dataType.substr(0,6)==="iframe"){g.context.find(".progress").addClass(!c.support.transition&&"progress-animated").attr("aria-valuenow",100).find(".bar").css("width","100%")}return f._trigger("sent",h,g)},done:function(i,h){var g=c(this).data("fileupload"),f;if(h.context){h.context.each(function(e){var j=(c.isArray(h.result)&&h.result[e])||{error:"emptyResult"};if(j.error){g._adjustMaxNumberOfFiles(1)}g._transition(c(this)).done(function(){var k=c(this);f=g._renderDownload([j]).replaceAll(k);g._forceReflow(f);g._transition(f).done(function(){h.context=c(this);g._trigger("completed",i,h)})})})}else{if(c.isArray(h.result)){c.each(h.result,function(e,j){if(h.maxNumberOfFilesAdjusted&&j.error){g._adjustMaxNumberOfFiles(1)}else{if(!h.maxNumberOfFilesAdjusted&&!j.error){g._adjustMaxNumberOfFiles(-1)}}});h.maxNumberOfFilesAdjusted=true}f=g._renderDownload(h.result).appendTo(g.options.filesContainer);g._forceReflow(f);g._transition(f).done(function(){h.context=c(this);g._trigger("completed",i,h)})}},fail:function(i,h){var g=c(this).data("fileupload"),f;if(h.maxNumberOfFilesAdjusted){g._adjustMaxNumberOfFiles(h.files.length)}if(h.context){h.context.each(function(e){if(h.errorThrown!=="abort"){var j=h.files[e];j.error=j.error||h.errorThrown||true;g._transition(c(this)).done(function(){var k=c(this);f=g._renderDownload([j]).replaceAll(k);g._forceReflow(f);g._transition(f).done(function(){h.context=c(this);g._trigger("failed",i,h)})})}else{g._transition(c(this)).done(function(){c(this).remove();g._trigger("failed",i,h)})}})}else{if(h.errorThrown!=="abort"){h.context=g._renderUpload(h.files).appendTo(g.options.filesContainer).data("data",h);g._forceReflow(h.context);g._transition(h.context).done(function(){h.context=c(this);g._trigger("failed",i,h)})}else{g._trigger("failed",i,h)}}},progress:function(h,g){if(g.context){var f=parseInt(g.loaded/g.total*100,10);g.context.find(".progress").attr("aria-valuenow",f).find(".bar").css("width",f+"%")}},progressall:function(j,h){var i=c(this),g=parseInt(h.loaded/h.total*100,10),f=i.find(".fileupload-progress"),k=f.find(".progress-extended");if(k.length){k.html(i.data("fileupload")._renderExtendedProgress(h))}f.find(".progress").attr("aria-valuenow",g).find(".bar").css("width",g+"%")},start:function(g){var f=c(this).data("fileupload");f._transition(c(this).find(".fileupload-progress")).done(function(){f._trigger("started",g)})},stop:function(g){var f=c(this).data("fileupload");f._transition(c(this).find(".fileupload-progress")).done(function(){c(this).find(".progress").attr("aria-valuenow","0").find(".bar").css("width","0%");c(this).find(".progress-extended").html("&nbsp;");f._trigger("stopped",g)})},destroy:function(h,g){var f=c(this).data("fileupload");if(g.url){c.ajax(g);f._adjustMaxNumberOfFiles(1)}f._transition(g.context).done(function(){c(this).remove();f._trigger("destroyed",h,g)})}},_enableDragToDesktop:function(){var h=c(this),f=h.prop("href"),e=h.prop("download"),g="application/octet-stream";h.bind("dragstart",function(j){try{j.originalEvent.dataTransfer.setData("DownloadURL",[g,e,f].join(":"))}catch(i){}})},_adjustMaxNumberOfFiles:function(e){if(typeof this.options.maxNumberOfFiles==="number"){this.options.maxNumberOfFiles+=e;if(this.options.maxNumberOfFiles<1){this._disableFileInputButton()}else{this._enableFileInputButton()}}},_formatFileSize:function(e){if(typeof e!=="number"){return""}if(e>=1000000000){return(e/1000000000).toFixed(2)+" GB"}if(e>=1000000){return(e/1000000).toFixed(2)+" MB"}return(e/1000).toFixed(2)+" KB"},_formatBitrate:function(e){if(typeof e!=="number"){return""}if(e>=1000000000){return(e/1000000000).toFixed(2)+" Gbit/s"}if(e>=1000000){return(e/1000000).toFixed(2)+" Mbit/s"}if(e>=1000){return(e/1000).toFixed(2)+" kbit/s"}return e+" bit/s"},_formatTime:function(f){var e=new Date(f*1000),g=parseInt(f/86400,10);g=g?g+"d ":"";return g+("0"+e.getUTCHours()).slice(-2)+":"+("0"+e.getUTCMinutes()).slice(-2)+":"+("0"+e.getUTCSeconds()).slice(-2)},_formatPercentage:function(e){return(e*100).toFixed(2)+" %"},_renderExtendedProgress:function(e){return this._formatBitrate(e.bitrate)+" | "+this._formatTime((e.total-e.loaded)*8/e.bitrate)+" | "+this._formatPercentage(e.loaded/e.total)+" | "+this._formatFileSize(e.loaded)+" / "+this._formatFileSize(e.total)},_hasError:function(e){if(e.error){return e.error}if(this.options.maxNumberOfFiles<0){return"maxNumberOfFiles"}if(!(this.options.acceptFileTypes.test(e.type)||this.options.acceptFileTypes.test(e.name))){return"acceptFileTypes"}if(this.options.maxFileSize&&e.size>this.options.maxFileSize){return"maxFileSize"}if(typeof e.size==="number"&&e.size<this.options.minFileSize){return"minFileSize"}return null},_validate:function(g){var f=this,e=!!g.length;c.each(g,function(h,i){i.error=f._hasError(i);if(i.error){e=false}});return e},_renderTemplate:function(g,f){if(!g){return c()}var e=g({files:f,formatFileSize:this._formatFileSize,options:this.options});if(e instanceof c){return e}return c(this.options.templatesContainer).html(e).children()},_renderPreview:function(g,i){var h=this,f=this.options,e=c.Deferred();return((d&&d(g,function(j){i.append(j);h._forceReflow(i);h._transition(i).done(function(){e.resolveWith(i)});if(!c.contains(document.body,i[0])){e.resolveWith(i)}},{maxWidth:f.previewMaxWidth,maxHeight:f.previewMaxHeight,canvas:f.previewAsCanvas}))||e.resolveWith(i))&&e},_renderPreviews:function(h,e){var g=this,f=this.options;e.find(".preview span").each(function(i,k){var j=h[i];if(f.previewSourceFileTypes.test(j.type)&&(c.type(f.previewSourceMaxFileSize)!=="number"||j.size<f.previewSourceMaxFileSize)){g._processingQueue=g._processingQueue.pipe(function(){var l=c.Deferred();g._renderPreview(j,c(k)).done(function(){l.resolveWith(g)});return l.promise()})}});return this._processingQueue},_renderUpload:function(e){return this._renderTemplate(this.options.uploadTemplate,e)},_renderDownload:function(e){return this._renderTemplate(this.options.downloadTemplate,e).find("a[download]").each(this._enableDragToDesktop).end()},_startHandler:function(i){i.preventDefault();var f=c(this),g=f.closest(".template-upload"),h=g.data("data");if(h&&h.submit&&!h.jqXHR&&h.submit()){f.prop("disabled",true)}},_cancelHandler:function(h){h.preventDefault();var f=c(this).closest(".template-upload"),g=f.data("data")||{};if(!g.jqXHR){g.errorThrown="abort";h.data.fileupload._trigger("fail",h,g)}else{g.jqXHR.abort()}},_deleteHandler:function(g){g.preventDefault();var f=c(this);g.data.fileupload._trigger("destroy",g,{context:f.closest(".template-download"),url:f.attr("data-url"),type:f.attr("data-type")||"DELETE",dataType:g.data.fileupload.options.dataType})},_forceReflow:function(e){return c.support.transition&&e.length&&e[0].offsetWidth},_transition:function(f){var e=c.Deferred();if(c.support.transition&&f.hasClass("fade")){f.bind(c.support.transition.end,function(g){if(g.target===f[0]){f.unbind(c.support.transition.end);e.resolveWith(f)}}).toggleClass("in")}else{f.toggleClass("in");e.resolveWith(f)}return e},_initButtonBarEventHandlers:function(){var f=this.element.find(".fileupload-buttonbar"),g=this.options.filesContainer,e=this.options.namespace;f.find(".start").bind("click."+e,function(h){h.preventDefault();g.find(".start button").click()});f.find(".cancel").bind("click."+e,function(h){h.preventDefault();g.find(".cancel button").click()});f.find(".delete").bind("click."+e,function(h){h.preventDefault();g.find(".delete input:checked").siblings("button").click();f.find(".toggle").prop("checked",false)});f.find(".toggle").bind("change."+e,function(h){g.find(".delete input").prop("checked",c(this).is(":checked"))})},_destroyButtonBarEventHandlers:function(){this.element.find(".fileupload-buttonbar button").unbind("click."+this.options.namespace);this.element.find(".fileupload-buttonbar .toggle").unbind("change."+this.options.namespace)},_initEventHandlers:function(){a.prototype._initEventHandlers.call(this);var e={fileupload:this};this.options.filesContainer.delegate(".start button","click."+this.options.namespace,e,this._startHandler).delegate(".cancel button","click."+this.options.namespace,e,this._cancelHandler).delegate(".delete button","click."+this.options.namespace,e,this._deleteHandler);this._initButtonBarEventHandlers()},_destroyEventHandlers:function(){var e=this.options;this._destroyButtonBarEventHandlers();e.filesContainer.undelegate(".start button","click."+e.namespace).undelegate(".cancel button","click."+e.namespace).undelegate(".delete button","click."+e.namespace);a.prototype._destroyEventHandlers.call(this)},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",false).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",true).parent().addClass("disabled")},_initTemplates:function(){var e=this.options;e.templatesContainer=document.createElement(e.filesContainer.prop("nodeName"));if(b){if(e.uploadTemplateId){e.uploadTemplate=b(e.uploadTemplateId)}if(e.downloadTemplateId){e.downloadTemplate=b(e.downloadTemplateId)}}},_initFilesContainer:function(){var e=this.options;if(e.filesContainer===undefined){e.filesContainer=this.element.find(".files")}else{if(!(e.filesContainer instanceof c)){e.filesContainer=c(e.filesContainer)}}},_stringToRegExp:function(g){var f=g.split("/"),e=f.pop();f.shift();return new RegExp(f.join("/"),e)},_initRegExpOptions:function(){var e=this.options;if(c.type(e.acceptFileTypes)==="string"){e.acceptFileTypes=this._stringToRegExp(e.acceptFileTypes)}if(c.type(e.previewSourceFileTypes)==="string"){e.previewSourceFileTypes=this._stringToRegExp(e.previewSourceFileTypes)}},_initSpecialOptions:function(){a.prototype._initSpecialOptions.call(this);this._initFilesContainer();this._initTemplates();this._initRegExpOptions()},_create:function(){a.prototype._create.call(this);this._refreshOptionsList.push("filesContainer","uploadTemplateId","downloadTemplateId");if(!c.blueimpFP){this._processingQueue=c.Deferred().resolveWith(this).promise();this.process=function(){return this._processingQueue}}},enable:function(){a.prototype.enable.call(this);this.element.find("input, button").prop("disabled",false);this._enableFileInputButton()},disable:function(){this.element.find("input, button").prop("disabled",true);this._disableFileInputButton();a.prototype.disable.call(this)}})}));
