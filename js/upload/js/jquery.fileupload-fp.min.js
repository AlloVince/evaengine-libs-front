(function(a){if(typeof define==="function"&&define.amd){define(["jquery","load-image","canvas-to-blob","./jquery.fileupload"],a)}else{a(window.jQuery,window.loadImage)}}(function(a,b){a.widget("blueimpFP.fileupload",a.blueimp.fileupload,{options:{process:[],add:function(d,c){a(this).fileupload("process",c).done(function(){c.submit()})}},processActions:{load:function(g,d){var f=this,e=g.files[g.index],c=a.Deferred();if(window.HTMLCanvasElement&&window.HTMLCanvasElement.prototype.toBlob&&(a.type(d.maxFileSize)!=="number"||e.size<d.maxFileSize)&&(!d.fileTypes||d.fileTypes.test(e.type))){b(e,function(h){g.canvas=h;c.resolveWith(f,[g])},{canvas:true})}else{c.rejectWith(f,[g])}return c.promise()},resize:function(e,d){if(e.canvas){var c=b.scale(e.canvas,d);if(c.width!==e.canvas.width||c.height!==e.canvas.height){e.canvas=c;e.processed=true}}return e},save:function(h,e){if(!h.canvas||!h.processed){return h}var g=this,f=h.files[h.index],d=f.name,c=a.Deferred(),i=function(j){if(!j.name){if(f.type===j.type){j.name=f.name}else{if(f.name){j.name=f.name.replace(/\..+$/,"."+j.type.substr(6))}}}h.files[h.index]=j;c.resolveWith(g,[h])};if(h.canvas.mozGetAsFile){i(h.canvas.mozGetAsFile((/^image\/(jpeg|png)$/.test(f.type)&&d)||((d&&d.replace(/\..+$/,""))||"blob")+".png",f.type))}else{h.canvas.toBlob(i,f.type)}return c.promise()}},_processFile:function(h,e,d){var g=this,c=a.Deferred().resolveWith(g,[{files:h,index:e}]),f=c.promise();g._processing+=1;a.each(d.process,function(j,k){f=f.pipe(function(i){return g.processActions[k.action].call(this,i,k)})});f.always(function(){g._processing-=1;if(g._processing===0){g.element.removeClass("fileupload-processing")}});if(g._processing===1){g.element.addClass("fileupload-processing")}return f},process:function(e){var d=this,c=a.extend({},this.options,e);if(c.process&&c.process.length&&this._isXHRUpload(c)){a.each(e.files,function(f,g){d._processingQueue=d._processingQueue.pipe(function(){var h=a.Deferred();d._processFile(e.files,f,c).always(function(){h.resolveWith(d)});return h.promise()})})}return this._processingQueue},_create:function(){a.blueimp.fileupload.prototype._create.call(this);this._processing=0;this._processingQueue=a.Deferred().resolveWith(this).promise()}})}));
